{% extends "base.html" %}

{% block content %}
<div x-data="emailClassifier()" x-init="init()">
    <!-- Hero Section with enhanced visuals -->
    <div class="text-center mb-12 animate-fade-in">
        <div class="relative">
            <h1 class="text-4xl md:text-5xl font-bold bg-gradient-to-r from-blue-600 via-purple-600 to-indigo-600 bg-clip-text text-transparent mb-4 animate-bounce-gentle">
                Classificador Inteligente de E-mails
            </h1>
            <p class="text-xl text-gray-600 dark:text-gray-300 mb-8 max-w-3xl mx-auto">
                Utilize inteligência artificial avançada para classificar e responder e-mails automaticamente
            </p>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl mx-auto mb-8">
                <div class="glass rounded-2xl p-6 hover:scale-105 transition-transform duration-300">
                    <div class="text-3xl font-bold text-blue-600 dark:text-blue-400 mb-2">90%+</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">Precisão na Classificação</div>
                </div>
                <div class="glass rounded-2xl p-6 hover:scale-105 transition-transform duration-300">
                    <div class="text-3xl font-bold text-green-600 dark:text-green-400 mb-2">&lt;2s</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">Tempo de Resposta</div>
                </div>
                <div class="glass rounded-2xl p-6 hover:scale-105 transition-transform duration-300">
                    <div class="text-3xl font-bold text-purple-600 dark:text-purple-400 mb-2">24/7</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">Disponibilidade</div>
                </div>
            </div>
        </div>
    </div>

    <div class="grid lg:grid-cols-2 gap-8">
        <!-- Enhanced Input Section -->
        <div class="space-y-6">
            <!-- Progress indicator -->
            <div class="glass rounded-2xl p-4" x-show="isProcessing">
                <div class="flex items-center space-x-3">
                    <div class="flex space-x-1">
                        <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0ms;"></div>
                        <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 150ms;"></div>
                        <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 300ms;"></div>
                    </div>
                    <span class="text-sm text-gray-600 dark:text-gray-400">Processando com IA...</span>
                </div>
                <div class="mt-3 bg-gray-200 dark:bg-gray-700 rounded-full h-2 overflow-hidden">
                    <div class="bg-gradient-to-r from-blue-500 to-purple-600 h-full rounded-full animate-pulse" style="width: 70%;"></div>
                </div>
            </div>

            <div class="glass rounded-3xl shadow-2xl p-8 border border-white/20 dark:border-gray-700/50 hover:shadow-3xl transition-all duration-500">
                <div class="flex items-center space-x-3 mb-6">
                    <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Classificar E-mail</h2>
                    <div class="flex-1"></div>
                    <div class="px-3 py-1 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 rounded-full text-xs font-medium">
                        IA Ativa
                    </div>
                </div>

                <form @submit.prevent="classifyEmail()" class="space-y-6">
                    <!-- Enhanced Text Input -->
                    <div class="relative">
                        <label for="email-text" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">
                            <div class="flex items-center space-x-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <span>Conteúdo do E-mail</span>
                            </div>
                        </label>
                        <div class="relative group">
                            <textarea
                                id="email-text"
                                x-model="emailText"
                                @input="updateCharCount()"
                                @keydown.ctrl.enter="classifyEmail()"
                                @focus="textareaFocused = true"
                                @blur="textareaFocused = false"
                                placeholder="Cole o texto do e-mail aqui..."
                                rows="10"
                                class="w-full px-6 py-4 border-2 border-gray-300/50 dark:border-gray-600/50 rounded-2xl focus:ring-4 focus:ring-blue-500/20 focus:border-blue-500 bg-white/80 dark:bg-gray-700/80 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 resize-none transition-all duration-300 backdrop-blur-sm"
                                :class="{
                                    'border-red-400 dark:border-red-500 focus:ring-red-500/20': charCount > maxChars,
                                    'animate-glow': textareaFocused
                                }"
                                :disabled="isProcessing"
                            ></textarea>

                            <!-- Enhanced Character Counter -->
                            <div class="absolute bottom-4 right-4 flex items-center space-x-2">
                                <div class="px-3 py-1 rounded-full text-xs font-medium backdrop-blur-sm"
                                     :class="charCount > maxChars ? 'bg-red-100/80 text-red-700 dark:bg-red-900/50 dark:text-red-300' : 'bg-gray-100/80 text-gray-600 dark:bg-gray-700/80 dark:text-gray-300'">
                                    <span x-text="charCount.toLocaleString()"></span>/<span x-text="maxChars.toLocaleString()"></span>
                                </div>
                                <div class="w-2 h-2 rounded-full transition-colors"
                                     :class="charCount > maxChars ? 'bg-red-500 animate-pulse' : charCount > maxChars * 0.8 ? 'bg-yellow-500' : 'bg-green-500'">
                                </div>
                            </div>

                            <!-- Word count and reading time -->
                            <div class="absolute top-4 right-4 text-xs text-gray-500 dark:text-gray-400">
                                <span x-text="emailText.split(' ').length"></span> palavras •
                                <span x-text="Math.ceil(emailText.split(' ').length / 200)"></span> min leitura
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced File Upload with drag animations -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">
                            <div class="flex items-center space-x-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                </svg>
                                <span>Upload de Arquivo</span>
                                <span class="text-xs text-gray-500">(opcional)</span>
                            </div>
                        </label>
                        <div
                            @dragover.prevent="dragOver = true"
                            @dragleave.prevent="dragOver = false"
                            @drop.prevent="handleFileDrop($event)"
                            class="drop-zone border-2 border-dashed border-gray-300/60 dark:border-gray-600/60 rounded-2xl p-8 text-center transition-all duration-300 cursor-pointer relative overflow-hidden"
                            :class="{
                                'drag-over border-blue-500 dark:border-blue-400 bg-blue-50/50 dark:bg-blue-900/20': dragOver,
                                'hover:border-gray-400 dark:hover:border-gray-500 hover:bg-gray-50/50 dark:hover:bg-gray-700/30': !dragOver
                            }"
                            @click="!selectedFile && $refs.fileInput.click()"
                        >
                            <input
                                type="file"
                                @change="handleFileSelect($event)"
                                accept=".txt,.pdf"
                                class="hidden"
                                x-ref="fileInput"
                                :disabled="isProcessing"
                            >

                            <!-- Upload animation background -->
                            <div class="absolute inset-0 opacity-0 transition-opacity duration-300" :class="{ 'opacity-100': dragOver }">
                                <div class="absolute inset-0 bg-gradient-to-r from-blue-400/10 to-purple-400/10 animate-pulse"></div>
                            </div>

                            <div x-show="!selectedFile" class="relative">
                                <div class="mx-auto w-16 h-16 mb-4 relative">
                                    <svg class="w-16 h-16 text-gray-400 transition-all duration-300" :class="dragOver ? 'text-blue-500 scale-110' : ''" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                    <div class="absolute inset-0 rounded-full border-2 border-dashed border-gray-300 animate-spin-slow opacity-20"></div>
                                </div>
                                <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-2" :class="dragOver ? 'text-blue-600 dark:text-blue-400' : ''">
                                    <span x-show="!dragOver">Arraste um arquivo aqui</span>
                                    <span x-show="dragOver" class="animate-bounce-gentle">Solte para fazer upload!</span>
                                </h3>
                                <p class="text-gray-600 dark:text-gray-400 mb-3">
                                    ou
                                    <button type="button" class="text-blue-600 hover:text-blue-500 font-semibold hover:underline transition-colors">
                                        clique para selecionar
                                    </button>
                                </p>
                                <div class="flex items-center justify-center space-x-4 text-xs text-gray-500 dark:text-gray-500">
                                    <div class="flex items-center space-x-1">
                                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                        </svg>
                                        <span>PDF, TXT</span>
                                    </div>
                                    <span>•</span>
                                    <div class="flex items-center space-x-1">
                                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h4a1 1 0 010 2H6.414l2.293 2.293a1 1 0 11-1.414 1.414L5 6.414V8a1 1 0 01-2 0V4zm9 1a1 1 0 010-2h4a1 1 0 011 1v4a1 1 0 01-2 0V6.414l-2.293 2.293a1 1 0 11-1.414-1.414L13.586 5H12z" clip-rule="evenodd"></path>
                                        </svg>
                                        <span>Máx. 5MB</span>
                                    </div>
                                </div>
                            </div>

                            <!-- File selected state with enhanced visuals -->
                            <div x-show="selectedFile" class="relative animate-fade-in">
                                <div class="flex flex-col items-center space-y-4">
                                    <div class="relative">
                                        <div class="w-16 h-16 bg-gradient-to-br from-green-400 to-blue-500 rounded-2xl flex items-center justify-center shadow-lg">
                                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                        </div>
                                        <div class="absolute -inset-1 bg-gradient-to-r from-green-400 to-blue-500 rounded-2xl blur opacity-30 animate-pulse"></div>
                                    </div>

                                    <div class="text-center">
                                        <p class="font-semibold text-gray-800 dark:text-gray-200" x-text="selectedFile?.name"></p>
                                        <p class="text-sm text-gray-500 dark:text-gray-400" x-text="selectedFile ? `${(selectedFile.size / 1024 / 1024).toFixed(2)} MB` : ''"></p>
                                    </div>

                                    <button
                                        type="button"
                                        @click.stop="clearFile()"
                                        class="flex items-center space-x-2 px-4 py-2 bg-red-100 hover:bg-red-200 dark:bg-red-900/50 dark:hover:bg-red-800/50 text-red-700 dark:text-red-300 rounded-xl transition-colors text-sm font-medium"
                                    >
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                        <span>Remover</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Tone Selection -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">
                            <div class="flex items-center space-x-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-1l-4 4z"></path>
                                </svg>
                                <span>Tom da Resposta</span>
                            </div>
                        </label>
                        <div class="grid grid-cols-3 gap-4">
                            <button
                                type="button"
                                @click="tone = 'formal'"
                                class="relative p-4 border-2 rounded-2xl text-center transition-all duration-300 group hover:scale-105"
                                :class="tone === 'formal' ? 'border-blue-500 bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 shadow-lg' : 'border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:border-gray-400 dark:hover:border-gray-500'"
                            >
                                <div class="mb-2">
                                    <div class="w-8 h-8 mx-auto rounded-lg flex items-center justify-center" :class="tone === 'formal' ? 'bg-blue-100 dark:bg-blue-800' : 'bg-gray-100 dark:bg-gray-600'">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                        </svg>
                                    </div>
                                </div>
                                <div class="font-semibold text-sm">Formal</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">Protocolar</div>

                                <!-- Selection indicator -->
                                <div x-show="tone === 'formal'" class="absolute -top-1 -right-1 w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center animate-bounce-gentle">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                </div>
                            </button>

                            <button
                                type="button"
                                @click="tone = 'neutro'"
                                class="relative p-4 border-2 rounded-2xl text-center transition-all duration-300 group hover:scale-105"
                                :class="tone === 'neutro' ? 'border-green-500 bg-green-50 dark:bg-green-900/30 text-green-700 dark:text-green-300 shadow-lg' : 'border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:border-gray-400 dark:hover:border-gray-500'"
                            >
                                <div class="mb-2">
                                    <div class="w-8 h-8 mx-auto rounded-lg flex items-center justify-center" :class="tone === 'neutro' ? 'bg-green-100 dark:bg-green-800' : 'bg-gray-100 dark:bg-gray-600'">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                        </svg>
                                    </div>
                                </div>
                                <div class="font-semibold text-sm">Neutro</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">Equilibrado</div>

                                <div x-show="tone === 'neutro'" class="absolute -top-1 -right-1 w-6 h-6 bg-green-500 text-white rounded-full flex items-center justify-center animate-bounce-gentle">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                </div>
                            </button>

                            <button
                                type="button"
                                @click="tone = 'amigavel'"
                                class="relative p-4 border-2 rounded-2xl text-center transition-all duration-300 group hover:scale-105"
                                :class="tone === 'amigavel' ? 'border-purple-500 bg-purple-50 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 shadow-lg' : 'border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:border-gray-400 dark:hover:border-gray-500'"
                            >
                                <div class="mb-2">
                                    <div class="w-8 h-8 mx-auto rounded-lg flex items-center justify-center" :class="tone === 'amigavel' ? 'bg-purple-100 dark:bg-purple-800' : 'bg-gray-100 dark:bg-gray-600'">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                </div>
                                <div class="font-semibold text-sm">Amigável</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">Caloroso</div>

                                <div x-show="tone === 'amigavel'" class="absolute -top-1 -right-1 w-6 h-6 bg-purple-500 text-white rounded-full flex items-center justify-center animate-bounce-gentle">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                </div>
                            </button>
                        </div>
                    </div>

                    <!-- Enhanced Submit Button -->
                    <button
                        type="submit"
                        :disabled="isProcessing || (!emailText.trim() && !selectedFile) || charCount > maxChars"
                        class="w-full btn-primary disabled:bg-gray-400 disabled:cursor-not-allowed text-white font-bold py-4 px-8 rounded-2xl transition-all duration-300 flex items-center justify-center space-x-3 group relative overflow-hidden"
                    >
                        <!-- Button background animation -->
                        <div class="absolute inset-0 bg-gradient-to-r from-blue-600 to-purple-600 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>

                        <div class="relative flex items-center space-x-3">
                            <svg x-show="isProcessing" class="animate-spin h-6 w-6" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>

                            <svg x-show="!isProcessing" class="w-6 h-6 group-hover:scale-110 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>

                            <span class="text-lg" x-text="isProcessing ? 'Processando com IA...' : 'Classificar E-mail'"></span>

                            <span x-show="!isProcessing" class="text-sm opacity-75 bg-white/20 px-2 py-1 rounded-lg">
                                Ctrl+Enter
                            </span>
                        </div>
                    </button>

                    <!-- Tips -->
                    <div class="mt-4 p-4 bg-blue-50/50 dark:bg-blue-900/20 rounded-xl border border-blue-200/50 dark:border-blue-800/50">
                        <div class="flex items-start space-x-3">
                            <svg class="w-5 h-5 text-blue-500 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div class="text-sm text-blue-700 dark:text-blue-300">
                                <div class="font-medium mb-1">💡 Dicas para melhores resultados:</div>
                                <ul class="space-y-1 text-blue-600 dark:text-blue-400">
                                    <li>• Inclua contexto completo do e-mail</li>
                                    <li>• Emails mais específicos geram respostas mais precisas</li>
                                    <li>• O sistema aprende com exemplos complexos</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Enhanced History Section -->
            <div class="glass rounded-3xl shadow-xl p-6 border border-white/20 dark:border-gray-700/50" x-show="history.length > 0">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-pink-600 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-bold text-gray-900 dark:text-white">Histórico Recente</h3>
                    </div>
                    <span class="px-3 py-1 bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 rounded-full text-xs font-medium">
                        <span x-text="history.length"></span> items
                    </span>
                </div>

                <div class="space-y-3 max-h-64 overflow-y-auto">
                    <template x-for="(item, index) in history" :key="item.id">
                        <div
                            @click="loadFromHistory(item)"
                            class="group p-4 bg-white/50 dark:bg-gray-700/50 backdrop-blur-sm rounded-2xl cursor-pointer hover:bg-white/80 dark:hover:bg-gray-600/80 transition-all duration-300 border border-gray-200/50 dark:border-gray-600/50 hover:shadow-lg hover:scale-[1.02]"
                            :class="{ 'animate-fade-in': index < 3 }"
                        >
                            <div class="flex justify-between items-start">
                                <div class="flex-1 min-w-0 space-y-2">
                                    <div class="flex items-center space-x-2">
                                        <div class="w-2 h-2 rounded-full" :class="item.category === 'Produtivo' ? 'bg-green-500' : 'bg-gray-500'"></div>
                                        <p class="text-sm text-gray-600 dark:text-gray-300 truncate font-medium" x-text="item.preview"></p>
                                    </div>
                                    <div class="flex items-center space-x-4 text-xs text-gray-500 dark:text-gray-400">
                                        <div class="flex items-center space-x-1">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                            <span x-text="item.timestamp"></span>
                                        </div>
                                        <div class="flex items-center space-x-1">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-1l-4 4z"></path>
                                            </svg>
                                            <span x-text="item.tone"></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="ml-4 flex items-center space-x-2">
                                    <span
                                        class="px-2 py-1 text-xs font-medium rounded-full transition-colors"
                                        :class="item.category === 'Produtivo' ? 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300' : 'bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300'"
                                        x-text="item.category"
                                    ></span>
                                    <svg class="w-4 h-4 text-gray-400 group-hover:text-gray-600 dark:group-hover:text-gray-300 opacity-0 group-hover:opacity-100 transition-all" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>

                <button
                    @click="clearHistory()"
                    class="mt-4 w-full flex items-center justify-center space-x-2 px-4 py-2 text-sm text-red-600 hover:text-red-500 dark:text-red-400 dark:hover:text-red-300 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-xl transition-colors"
                >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    <span>Limpar Histórico</span>
                </button>
            </div>
        </div>

        <!-- Enhanced Results Section -->
        <div class="space-y-6">
            <!-- Enhanced Loading State -->
            <div x-show="isProcessing" class="glass rounded-3xl shadow-2xl p-8 border border-white/20 dark:border-gray-700/50 animate-fade-in">
                <div class="text-center space-y-6">
                    <!-- AI Processing animation -->
                    <div class="relative w-24 h-24 mx-auto">
                        <div class="absolute inset-0 rounded-full border-4 border-blue-200 dark:border-blue-800"></div>
                        <div class="absolute inset-0 rounded-full border-4 border-blue-500 border-t-transparent animate-spin"></div>
                        <div class="absolute inset-2 rounded-full border-4 border-purple-300 dark:border-purple-700"></div>
                        <div class="absolute inset-2 rounded-full border-4 border-purple-500 border-r-transparent animate-spin" style="animation-direction: reverse; animation-duration: 2s;"></div>
                        <div class="absolute inset-4 flex items-center justify-center">
                            <svg class="w-8 h-8 text-blue-500 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                        </div>
                    </div>

                    <div class="space-y-3">
                        <h3 class="text-xl font-bold text-gray-900 dark:text-white">IA Processando...</h3>
                        <p class="text-gray-600 dark:text-gray-400">Analisando conteúdo com inteligência artificial</p>

                        <!-- Progress steps -->
                        <div class="space-y-2 max-w-sm mx-auto">
                            <div class="flex items-center space-x-3 text-sm">
                                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                <span class="text-gray-600 dark:text-gray-400">Preprocessamento NLP</span>
                            </div>
                            <div class="flex items-center space-x-3 text-sm">
                                <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse" style="animation-delay: 0.5s;"></div>
                                <span class="text-gray-600 dark:text-gray-400">Classificação com GPT-4o-mini</span>
                            </div>
                            <div class="flex items-center space-x-3 text-sm">
                                <div class="w-2 h-2 bg-purple-500 rounded-full animate-pulse" style="animation-delay: 1s;"></div>
                                <span class="text-gray-600 dark:text-gray-400">Gerando resposta otimizada</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Results Display -->
            <div x-show="result && !isProcessing" class="glass rounded-3xl shadow-2xl p-8 border border-white/20 dark:border-gray-700/50 animate-slide-up">
                <div class="flex items-center justify-between mb-8">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-r from-green-400 to-blue-500 rounded-xl flex items-center justify-center">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <h3 class="text-2xl font-bold bg-gradient-to-r from-gray-900 via-blue-800 to-purple-800 dark:from-white dark:via-blue-200 dark:to-purple-200 bg-clip-text text-transparent">
                            Análise Completa
                        </h3>
                    </div>
                    <div class="px-4 py-2 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 rounded-full text-sm font-medium">
                        ✓ Processado
                    </div>
                </div>

                <!-- Category and Confidence with enhanced design -->
                <div class="grid md:grid-cols-2 gap-8 mb-8">
                    <!-- Category Card -->
                    <div class="relative group">
                        <div class="absolute inset-0 bg-gradient-to-r from-blue-500 to-purple-600 rounded-2xl blur opacity-20 group-hover:opacity-30 transition-opacity"></div>
                        <div class="relative bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-200 dark:border-gray-700">
                            <div class="flex items-center space-x-3 mb-4">
                                <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                                </svg>
                                <h4 class="text-lg font-bold text-gray-900 dark:text-white">Categoria</h4>
                            </div>
                            <div class="flex items-center space-x-3">
                                <span
                                    class="px-4 py-2 rounded-2xl text-lg font-bold shadow-lg transition-all hover:scale-105"
                                    :class="result?.category === 'Produtivo' ? 'bg-gradient-to-r from-green-400 to-emerald-500 text-white' : 'bg-gradient-to-r from-gray-400 to-slate-500 text-white'"
                                    x-text="result?.category"
                                ></span>
                                <div class="text-2xl animate-bounce" x-text="result?.category === 'Produtivo' ? '🚀' : '💬'"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Confidence Gauge -->
                    <div class="relative group">
                        <div class="absolute inset-0 bg-gradient-to-r from-green-500 to-blue-600 rounded-2xl blur opacity-20 group-hover:opacity-30 transition-opacity"></div>
                        <div class="relative bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-200 dark:border-gray-700">
                            <div class="flex items-center space-x-3 mb-4">
                                <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                                <h4 class="text-lg font-bold text-gray-900 dark:text-white">Confiança</h4>
                            </div>

                            <div class="flex items-center space-x-4">
                                <!-- Enhanced Confidence Gauge -->
                                <div class="relative w-20 h-20">
                                    <svg class="w-20 h-20 transform -rotate-90" viewBox="0 0 36 36">
                                        <path
                                            class="text-gray-200 dark:text-gray-700"
                                            stroke="currentColor"
                                            stroke-width="3"
                                            fill="none"
                                            d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                        />
                                        <path
                                            class="gauge-fill transition-all duration-1000 ease-out"
                                            :class="getConfidenceColor(result?.confidence)"
                                            stroke="currentColor"
                                            stroke-width="4"
                                            stroke-linecap="round"
                                            fill="none"
                                            :stroke-dasharray="`${(result?.confidence || 0) * 100} 100`"
                                            d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                            style="filter: drop-shadow(0 0 6px currentColor);"
                                        />
                                    </svg>
                                    <div class="absolute inset-0 flex flex-col items-center justify-center">
                                        <span class="text-xl font-bold" x-text="Math.round((result?.confidence || 0) * 100) + '%'"></span>
                                    </div>
                                </div>

                                <div class="flex-1">
                                    <div class="text-lg font-semibold mb-1" :class="getConfidenceColor(result?.confidence).replace('text-', 'text-')" x-text="getConfidenceText(result?.confidence)"></div>
                                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                        <div
                                            class="h-2 rounded-full transition-all duration-1000 ease-out"
                                            :class="getConfidenceColor(result?.confidence).replace('text-', 'bg-')"
                                            :style="`width: ${(result?.confidence || 0) * 100}%`"
                                        ></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Rationale Card -->
                <div class="relative group mb-8">
                    <div class="absolute inset-0 bg-gradient-to-r from-purple-500 to-pink-600 rounded-2xl blur opacity-10 group-hover:opacity-20 transition-opacity"></div>
                    <div class="relative bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-200 dark:border-gray-700">
                        <div class="flex items-start space-x-3 mb-4">
                            <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-pink-600 rounded-lg flex items-center justify-center flex-shrink-0">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364-.636l-.707.707M21 12h-1M18.364 18.364l-.707-.707M12 21v-1m-6.364-.636l.707-.707M3 12h1m2.636-6.364l.707.707M12 6.5a5.5 5.5 0 110 11 5.5 5.5 0 010-11z"></path>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <h4 class="text-lg font-bold text-gray-900 dark:text-white mb-2">Análise Inteligente</h4>
                                <p class="text-gray-600 dark:text-gray-300 text-base leading-relaxed bg-gradient-to-r from-gray-50 to-blue-50 dark:from-gray-700 dark:to-blue-900/20 p-4 rounded-xl border-l-4 border-purple-500" x-text="result?.rationale"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Generated Reply -->
                <div class="relative group mb-8">
                    <div class="absolute inset-0 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-2xl blur opacity-10 group-hover:opacity-20 transition-opacity"></div>
                    <div class="relative bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-200 dark:border-gray-700">
                        <div class="flex justify-between items-center mb-4">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center">
                                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                    </svg>
                                </div>
                                <h4 class="text-lg font-bold text-gray-900 dark:text-white">Resposta Gerada</h4>
                            </div>
                            <div class="flex space-x-2">
                                <button
                                    @click="copyReply()"
                                    class="flex items-center space-x-2 px-4 py-2 bg-blue-100 hover:bg-blue-200 dark:bg-blue-900/30 dark:hover:bg-blue-800/50 text-blue-700 dark:text-blue-300 rounded-xl transition-all duration-200 text-sm font-medium hover:scale-105"
                                >
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                    </svg>
                                    <span>Copiar</span>
                                </button>

                                <button
                                    @click="exportReply()"
                                    class="flex items-center space-x-2 px-4 py-2 bg-green-100 hover:bg-green-200 dark:bg-green-900/30 dark:hover:bg-green-800/50 text-green-700 dark:text-green-300 rounded-xl transition-all duration-200 text-sm font-medium hover:scale-105"
                                >
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <span>Exportar</span>
                                </button>
                            </div>
                        </div>

                        <div class="relative">
                            <div class="bg-gradient-to-br from-gray-50 to-blue-50 dark:from-gray-700 dark:to-blue-900/30 p-6 rounded-2xl border border-gray-200/50 dark:border-gray-600/50">
                                <div class="prose prose-sm dark:prose-invert max-w-none">
                                    <p class="text-gray-900 dark:text-white whitespace-pre-line text-base leading-relaxed font-medium" x-text="result?.reply"></p>
                                </div>
                            </div>

                            <!-- Word count for reply -->
                            <div class="absolute top-2 right-2 px-2 py-1 bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm rounded-lg text-xs text-gray-500 dark:text-gray-400">
                                <span x-text="(result?.reply || '').split(' ').length"></span> palavras
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Refine Reply Section -->
                <div class="relative group mb-8">
                    <div class="absolute inset-0 bg-gradient-to-r from-orange-500 to-red-600 rounded-2xl blur opacity-10 group-hover:opacity-20 transition-opacity"></div>
                    <div class="relative bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-200 dark:border-gray-700">
                        <div class="flex items-center space-x-3 mb-4">
                            <div class="w-8 h-8 bg-gradient-to-r from-orange-500 to-red-600 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                            </div>
                            <h4 class="text-lg font-bold text-gray-900 dark:text-white">Refinar Resposta</h4>
                        </div>

                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                            Ajuste o tom da resposta para melhor adequação ao contexto
                        </p>

                        <div class="grid grid-cols-3 gap-3">
                            <button
                                @click="refineReply('formal')"
                                :disabled="isRefining"
                                class="group flex flex-col items-center p-4 border-2 rounded-2xl transition-all duration-300 hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed"
                                :class="isRefining ? 'border-gray-300 dark:border-gray-600' : 'border-blue-300 dark:border-blue-600 hover:border-blue-500 dark:hover:border-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/20'"
                            >
                                <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900/50 rounded-xl flex items-center justify-center mb-2 group-hover:scale-110 transition-transform">
                                    <svg class="w-5 h-5 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                    </svg>
                                </div>
                                <span class="font-semibold text-blue-700 dark:text-blue-300">Formal</span>
                                <span class="text-xs text-gray-500 dark:text-gray-400 mt-1">Protocolar</span>
                            </button>

                            <button
                                @click="refineReply('neutro')"
                                :disabled="isRefining"
                                class="group flex flex-col items-center p-4 border-2 rounded-2xl transition-all duration-300 hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed"
                                :class="isRefining ? 'border-gray-300 dark:border-gray-600' : 'border-green-300 dark:border-green-600 hover:border-green-500 dark:hover:border-green-400 hover:bg-green-50 dark:hover:bg-green-900/20'"
                            >
                                <div class="w-10 h-10 bg-green-100 dark:bg-green-900/50 rounded-xl flex items-center justify-center mb-2 group-hover:scale-110 transition-transform">
                                    <svg class="w-5 h-5 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                    </svg>
                                </div>
                                <span class="font-semibold text-green-700 dark:text-green-300">Neutro</span>
                                <span class="text-xs text-gray-500 dark:text-gray-400 mt-1">Equilibrado</span>
                            </button>

                            <button
                                @click="refineReply('amigavel')"
                                :disabled="isRefining"
                                class="group flex flex-col items-center p-4 border-2 rounded-2xl transition-all duration-300 hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed"
                                :class="isRefining ? 'border-gray-300 dark:border-gray-600' : 'border-purple-300 dark:border-purple-600 hover:border-purple-500 dark:hover:border-purple-400 hover:bg-purple-50 dark:hover:bg-purple-900/20'"
                            >
                                <div class="w-10 h-10 bg-purple-100 dark:bg-purple-900/50 rounded-xl flex items-center justify-center mb-2 group-hover:scale-110 transition-transform">
                                    <svg class="w-5 h-5 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <span class="font-semibold text-purple-700 dark:text-purple-300">Amigável</span>
                                <span class="text-xs text-gray-500 dark:text-gray-400 mt-1">Caloroso</span>
                            </button>
                        </div>

                        <!-- Refining indicator -->
                        <div x-show="isRefining" class="mt-4 flex items-center justify-center space-x-3 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-xl animate-fade-in">
                            <svg class="w-5 h-5 text-blue-500 animate-spin" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span class="text-blue-700 dark:text-blue-300 font-medium">Refinando resposta...</span>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Metadata Section -->
                <div class="glass rounded-2xl p-6 border border-white/20 dark:border-gray-700/50">
                    <div class="flex items-center space-x-3 mb-4">
                        <div class="w-6 h-6 bg-gradient-to-r from-gray-500 to-slate-600 rounded-lg flex items-center justify-center">
                            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                        <h4 class="text-lg font-bold text-gray-900 dark:text-white">Métricas Detalhadas</h4>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <!-- Latency -->
                        <div class="text-center p-4 bg-white/50 dark:bg-gray-700/50 rounded-xl border border-gray-200/50 dark:border-gray-600/50">
                            <div class="text-2xl font-bold text-blue-600 dark:text-blue-400 mb-1" x-text="result?.latency_ms + 'ms'"></div>
                            <div class="text-xs text-gray-500 dark:text-gray-400 flex items-center justify-center space-x-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <span>Latência</span>
                            </div>
                        </div>

                        <!-- Model -->
                        <div class="text-center p-4 bg-white/50 dark:bg-gray-700/50 rounded-xl border border-gray-200/50 dark:border-gray-600/50">
                            <div class="text-sm font-bold text-purple-600 dark:text-purple-400 mb-1 truncate" x-text="result?.meta?.model || 'N/A'"></div>
                            <div class="text-xs text-gray-500 dark:text-gray-400 flex items-center justify-center space-x-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                </svg>
                                <span>Modelo</span>
                            </div>
                        </div>

                        <!-- Cost -->
                        <div x-show="result?.meta?.cost > 0" class="text-center p-4 bg-white/50 dark:bg-gray-700/50 rounded-xl border border-gray-200/50 dark:border-gray-600/50">
                            <div class="text-sm font-bold text-green-600 dark:text-green-400 mb-1" x-text="'$' + (result?.meta?.cost || 0).toFixed(6)"></div>
                            <div class="text-xs text-gray-500 dark:text-gray-400 flex items-center justify-center space-x-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                </svg>
                                <span>Custo</span>
                            </div>
                        </div>

                        <!-- Fallback indicator -->
                        <div x-show="result?.meta?.fallback" class="text-center p-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-xl border border-yellow-200/50 dark:border-yellow-800/50">
                            <div class="text-sm font-bold text-yellow-600 dark:text-yellow-400 mb-1">Fallback</div>
                            <div class="text-xs text-yellow-500 dark:text-yellow-400 flex items-center justify-center space-x-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                                <span>Sistema</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function emailClassifier() {
    return {
        emailText: '',
        selectedFile: null,
        tone: 'neutro',
        charCount: 0,
        maxChars: 10000,
        isProcessing: false,
        isRefining: false,
        dragOver: false,
        textareaFocused: false,
        result: null,
        history: [],

        init() {
            this.loadHistory();
            // Auto-save draft
            this.$watch('emailText', () => {
                localStorage.setItem('email-classifier-draft', this.emailText);
            });

            // Load draft
            const draft = localStorage.getItem('email-classifier-draft');
            if (draft && draft.length > 10) {
                this.emailText = draft;
                this.updateCharCount();
            }
        },

        updateCharCount() {
            this.charCount = this.emailText.length;
        },

        handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) { // 5MB limit
                    this.showToast('Arquivo muito grande. Máximo 5MB permitido.', 'error');
                    return;
                }
                this.selectedFile = file;
                this.emailText = ''; // Clear text input when file is selected
                this.showToast(`Arquivo "${file.name}" selecionado`, 'success');
            }
        },

        handleFileDrop(event) {
            this.dragOver = false;
            const file = event.dataTransfer.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    this.showToast('Arquivo muito grande. Máximo 5MB permitido.', 'error');
                    return;
                }
                this.selectedFile = file;
                this.emailText = '';
                this.showToast(`Arquivo "${file.name}" carregado via drag & drop`, 'success');
            }
        },

        clearFile() {
            this.selectedFile = null;
            this.$refs.fileInput.value = '';
            this.showToast('Arquivo removido', 'info');
        },

        async classifyEmail() {
            if (this.isProcessing) return;

            if (!this.emailText.trim() && !this.selectedFile) {
                this.showToast('Por favor, insira um texto ou selecione um arquivo', 'warning');
                return;
            }

            if (this.charCount > this.maxChars) {
                this.showToast('Texto excede o limite de caracteres', 'error');
                return;
            }

            this.isProcessing = true;
            this.result = null;

            const startTime = performance.now();

            try {
                const formData = new FormData();
                if (this.selectedFile) {
                    formData.append('file', this.selectedFile);
                } else {
                    formData.append('text', this.emailText);
                }
                formData.append('tone', this.tone);

                const response = await fetch('/classify', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Erro ao classificar e-mail');
                }

                const result = await response.json();

                // Add client-side latency calculation
                const endTime = performance.now();
                result.latency_ms = Math.round(endTime - startTime);

                this.result = result;
                this.addToHistory(result);
                this.showToast('E-mail classificado com sucesso! 🎉', 'success');

                // Clear draft after successful classification
                localStorage.removeItem('email-classifier-draft');

            } catch (error) {
                this.showToast(error.message || 'Erro ao processar solicitação', 'error');
                console.error('Erro:', error);
            } finally {
                this.isProcessing = false;
            }
        },

        async refineReply(newTone) {
            if (this.isRefining || !this.result?.reply) return;

            this.isRefining = true;

            try {
                const response = await fetch('/refine', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: this.result.reply,
                        tone: newTone
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Erro ao refinar resposta');
                }

                const refined = await response.json();
                this.result.reply = refined.reply;
                this.showToast(`Resposta refinada para tom ${newTone}! ✨`, 'success');

            } catch (error) {
                this.showToast(error.message || 'Erro ao refinar resposta', 'error');
            } finally {
                this.isRefining = false;
            }
        },

        copyReply() {
            if (!this.result?.reply) return;

            navigator.clipboard.writeText(this.result.reply).then(() => {
                this.showToast('Resposta copiada para a área de transferência! 📋', 'success');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = this.result.reply;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    this.showToast('Resposta copiada! 📋', 'success');
                } catch (err) {
                    this.showToast('Erro ao copiar resposta', 'error');
                }
                document.body.removeChild(textArea);
            });
        },

        exportReply() {
            if (!this.result?.reply) return;

            const content = `Classificação: ${this.result.category}\nTom: ${this.tone}\nConfiança: ${Math.round((this.result.confidence || 0) * 100)}%\n\nResposta:\n${this.result.reply}\n\nJustificativa:\n${this.result.rationale}`;

            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `resposta_email_${new Date().toISOString().slice(0, 10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            this.showToast('Resposta exportada como arquivo! 💾', 'success');
        },

        getConfidenceColor(confidence) {
            if (confidence >= 0.8) return 'text-green-500';
            if (confidence >= 0.6) return 'text-yellow-500';
            return 'text-red-500';
        },

        getConfidenceText(confidence) {
            if (confidence >= 0.9) return 'Excelente';
            if (confidence >= 0.8) return 'Alta confiança';
            if (confidence >= 0.6) return 'Média confiança';
            if (confidence >= 0.4) return 'Baixa confiança';
            return 'Muito baixa';
        },

        addToHistory(result) {
            const historyItem = {
                id: Date.now(),
                preview: (this.emailText || `Arquivo: ${this.selectedFile?.name}`).substring(0, 100) + '...',
                category: result.category,
                timestamp: new Date().toLocaleString('pt-BR'),
                text: this.emailText,
                file: this.selectedFile?.name,
                tone: this.tone,
                result: result
            };

            this.history.unshift(historyItem);
            this.history = this.history.slice(0, 10); // Keep only last 10
            this.saveHistory();
        },

        loadFromHistory(item) {
            if (confirm('Carregar este item do histórico? Os dados atuais serão substituídos.')) {
                this.emailText = item.text || '';
                this.tone = item.tone;
                this.result = item.result;
                this.selectedFile = null;
                this.updateCharCount();
                this.showToast(`Item "${item.preview.substring(0, 30)}..." carregado`, 'info');

                // Scroll to top smoothly
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        },

        loadHistory() {
            const saved = localStorage.getItem('email-classifier-history');
            if (saved) {
                try {
                    this.history = JSON.parse(saved);
                } catch (e) {
                    console.warn('Erro ao carregar histórico:', e);
                    this.history = [];
                }
            }
        },

        saveHistory() {
            try {
                localStorage.setItem('email-classifier-history', JSON.stringify(this.history));
            } catch (e) {
                console.warn('Erro ao salvar histórico:', e);
            }
        },

        clearHistory() {
            if (confirm('Tem certeza que deseja limpar todo o histórico?')) {
                this.history = [];
                localStorage.removeItem('email-classifier-history');
                localStorage.removeItem('email-classifier-draft');
                this.showToast('Histórico limpo com sucesso! 🗑️', 'info');
            }
        },

        showToast(message, type = 'info') {
            // Create toast with enhanced styling
            const toast = document.createElement('div');
            toast.className = `transform transition-all duration-500 ease-out`;

            const colors = {
                success: 'bg-green-100 dark:bg-green-900/50 border-green-500 text-green-800 dark:text-green-200',
                error: 'bg-red-100 dark:bg-red-900/50 border-red-500 text-red-800 dark:text-red-200',
                warning: 'bg-yellow-100 dark:bg-yellow-900/50 border-yellow-500 text-yellow-800 dark:text-yellow-200',
                info: 'bg-blue-100 dark:bg-blue-900/50 border-blue-500 text-blue-800 dark:text-blue-200'
            };

            const icons = {
                success: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
                error: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
                warning: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>',
                info: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
            };

            toast.className += ` max-w-md glass rounded-2xl shadow-2xl p-4 border-l-4 ${colors[type] || colors.info} animate-slide-down`;

            toast.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="flex-shrink-0">
                        ${icons[type] || icons.info}
                    </div>
                    <div class="flex-1">
                        <p class="font-medium">${message}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.style.transform='translateX(100%)'; setTimeout(() => this.parentElement.parentElement.remove(), 300)"
                            class="flex-shrink-0 p-1 rounded-lg hover:bg-black/10 transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            `;

            const container = document.getElementById('toast-container');
            container.appendChild(toast);

            // Auto remove after delay
            const delay = type === 'error' ? 8000 : 5000;
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.style.transform = 'translateX(100%)';
                    toast.style.opacity = '0';
                    setTimeout(() => {
                        if (toast.parentElement) {
                            toast.remove();
                        }
                    }, 300);
                }
            }, delay);

            // Add sound effect for success
            if (type === 'success') {
                this.playNotificationSound();
            }
        },

        playNotificationSound() {
            // Create a subtle success sound using Web Audio API
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);

                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.2);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
            } catch (e) {
                // Silence is golden if audio fails
            }
        },

        // Keyboard shortcuts
        handleKeyPress(event) {
            // Ctrl+Enter to submit
            if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
                event.preventDefault();
                this.classifyEmail();
            }

            // Ctrl+/ to focus textarea
            if ((event.ctrlKey || event.metaKey) && event.key === '/') {
                event.preventDefault();
                document.getElementById('email-text').focus();
            }
        }
    }
}

// Global keyboard shortcuts
document.addEventListener('keydown', (event) => {
    // Access Alpine component instance
    if (window.Alpine && Alpine.raw) {
        const component = Alpine.raw(document.querySelector('[x-data]').__x);
        if (component && component.handleKeyPress) {
            component.handleKeyPress(event);
        }
    }
});

// Add smooth scrolling behavior for better UX
document.addEventListener('DOMContentLoaded', () => {
    // Enhanced smooth scrolling for all anchor links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });

    // Add loading states to all forms
    document.querySelectorAll('form').forEach(form => {
        form.addEventListener('submit', function() {
            const submitBtn = this.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.style.transform = 'scale(0.98)';
                setTimeout(() => {
                    submitBtn.style.transform = '';
                }, 200);
            }
        });
    });
});
</script>
{% endblock %}
